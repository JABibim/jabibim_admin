<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jabibim.admin.mybatis.mapper.TeacherMapper">

    <select id="getTeacherCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TEACHER
        <where>
            <if test="state != 'option1'">
                DELETED_AT IS
                <choose>
                    <when test="state == 'option2'">NULL</when>
                    <otherwise>NOT NULL</otherwise>
                </choose>
            </if>
            <if test='search_field == "0"'>
                AND (TEACHER_NAME LIKE CONCAT('%', #{search_word}, '%')
                OR TEACHER_EMAIL LIKE CONCAT('%', #{search_word}, '%'))
            </if>
            <if test='search_field == "1"'>
                AND TEACHER_EMAIL LIKE CONCAT('%', #{search_word}, '%')
            </if>
            <if test='search_field == "2"'>
                AND TEACHER_NAME LIKE CONCAT('%', #{search_word}, '%')
            </if>
        </where>
    </select>

    <select id="getTeacherList" parameterType="map" resultType="Teacher">
        SELECT *
        FROM (
        SELECT ROW_NUMBER() OVER (ORDER BY A.ACADEMY_NAME, T.TEACHER_NAME) AS rnum,
        A.ACADEMY_NAME, T.TEACHER_NAME, T.TEACHER_ID, T.TEACHER_PHONE, T.TEACHER_EMAIL, T.DELETED_AT
        FROM TEACHER T
        JOIN ACADEMY A ON A.ACADEMY_ID = T.ACADEMY_ID
        <if test="!isAdmin">
            WHERE A.ACADEMY_ID = #{academyId}
        </if>
        <if test="state != 'option1'">
            AND T.DELETED_AT IS ${state == 'option2' ? 'NULL' : 'NOT NULL'}
        </if>
        <if test='search_field == "0"'>
            AND (TEACHER_NAME LIKE CONCAT('%', #{search_word}, '%')
            OR TEACHER_EMAIL LIKE CONCAT('%', #{search_word}, '%'))
        </if>
        <if test='search_field == "1"'>
            AND T.TEACHER_EMAIL LIKE CONCAT('%', #{search_word}, '%')
        </if>
        <if test='search_field == "2"'>
            AND T.TEACHER_NAME LIKE CONCAT('%', #{search_word}, '%')
        </if>
        ) AS subquery
        WHERE rnum BETWEEN #{start} AND #{end}
    </select>

    <select id="teacherInfo" resultType="teacher">
        select *
        from teacher
        where teacher_id = #{id}
    </select>

    <update id="update">
        update teacher
        set teacher_img_origin = #{teacherImgOrigin},
            teacher_phone = #{teacherPhone},
            teacher_email = #{teacherEmail}
        where teacher_id = #{teacherId}

    </update>

    <update id="updatePassword">
        update teacher
        set teacher_password = #{teacherPassword}
        where teacher_id = #{teacherId}
    </update>

    <select id="getTeacherById">
        select *
        from teacher
        where teacher_id = #{teacherId}
    </select>

    <update id="updateProfileImage">
        update teacher
        set teacher_img_name = #{teacherImgName}
        where teacher_id = #{teacherId}
    </update>


</mapper>