<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jabibim.admin.mybatis.mapper.StudentMapper">

    <select id="getStudentCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM (
        SELECT
        A.academy_name, S.student_name, S.student_email, S.created_at, S.deleted_at
        FROM student S
        JOIN academy A ON A.academy_id = S.academy_id
        <where>
            <!-- 상태에 따른 조건 -->
            <if test="state == 'option2'">
                S.DELETED_AT IS NULL
            </if>
            <if test="state == 'option3'">
                S.DELETED_AT IS NOT NULL
            </if>
            <!-- 관리자 여부에 따른 조건 -->
            <if test="!isAdmin">
                AND S.ACADEMY_ID = #{academyId}
            </if>
            <!-- 날짜 조건 -->
            <if test="startDate != null and startDate != 'null'">
                AND S.CREATED_AT &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != 'null'">
                AND S.CREATED_AT &lt;= #{endDate}
            </if>
            <!-- 학년 조건 -->
            <if test='studentGrade == "0"'>
                AND S.GRADE_ID IN (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId}
                )
            </if>
            <if test='studentGrade == "1"'>
                AND S.GRADE_ID = (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId} AND GRADE_NAME = 'BRONZE'
                )
            </if>
            <if test='studentGrade == "2"'>
                AND S.GRADE_ID = (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId} AND GRADE_NAME = 'SILVER'
                )
            </if>
            <if test='studentGrade == "3"'>
                AND S.GRADE_ID = (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId} AND GRADE_NAME = 'GOLD'
                )
            </if>
            <!-- 검색 조건 -->
            <if test='search_field == "0"'>
                AND (student_name LIKE CONCAT('%', #{search_word}, '%')
                OR student_email LIKE CONCAT('%', #{search_word}, '%'))
            </if>
            <if test='search_field == "1"'>
                AND student_name LIKE CONCAT('%', #{search_word}, '%')
            </if>
            <if test='search_field == "2"'>
                AND student_email LIKE CONCAT('%', #{search_word}, '%')
            </if>
        </where>
        ) AS subquery
    </select>

    <select id="getStudentList" parameterType="map" resultType="student">
        SELECT *
        FROM (
        SELECT ROW_NUMBER() OVER (ORDER BY A.ACADEMY_NAME, S.student_name) AS rnum,
        A.academy_name, S.student_name, S.student_email, S.created_at, S.deleted_at
        FROM student S
        JOIN academy A ON A.academy_id = s.academy_id
        <where>
            <!-- 상태 조건 -->
            <if test="state == 'option2'">
                S.DELETED_AT IS NULL
            </if>
            <if test="state == 'option3'">
                S.DELETED_AT IS NOT NULL
            </if>
            <!-- 관리자 여부 -->
            <if test="!isAdmin">
                AND S.ACADEMY_ID = #{academyId}
            </if>
            <!-- 날짜 조건 -->
            <if test="startDate != null and startDate != 'null'">
                AND S.CREATED_AT &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != 'null'">
                AND S.CREATED_AT &lt;= #{endDate}
            </if>
            <!-- 학년 조건 -->
            <if test='studentGrade == "0"'>
                AND S.GRADE_ID IN (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId}
                )
            </if>
            <if test='studentGrade == "1"'>
                AND S.GRADE_ID = (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId} AND GRADE_NAME = 'BRONZE'
                )
            </if>
            <if test='studentGrade == "2"'>
                AND S.GRADE_ID = (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId} AND GRADE_NAME = 'SILVER'
                )
            </if>
            <if test='studentGrade == "3"'>
                AND S.GRADE_ID = (
                SELECT GRADE_ID
                FROM GRADE
                WHERE ACADEMY_ID = #{academyId} AND GRADE_NAME = 'GOLD'
                )
            </if>
            <!-- 검색 조건 -->
            <if test='search_field == "0"'>
                AND (student_name LIKE CONCAT('%', #{search_word}, '%')
                OR student_email LIKE CONCAT('%', #{search_word}, '%'))
            </if>
            <if test='search_field == "1"'>
                AND student_name LIKE CONCAT('%', #{search_word}, '%')
            </if>
            <if test='search_field == "2"'>
                AND student_email LIKE CONCAT('%', #{search_word}, '%')
            </if>
        </where>
        ) AS subquery
        WHERE rnum BETWEEN #{start} AND #{end}
    </select>
    
    <select id="getStudentAdCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM student
        <where>
            <if test="!isAdmin">
                ACADEMY_ID = #{academyId}
            </if>
        </where>
    </select>

    <select id="getStudentAdList" parameterType="map" resultType="student">
        SELECT *
        FROM (
        SELECT ROW_NUMBER() OVER (ORDER BY student_id) AS rnum,
        student_id,
        student_name,
        student_email,
        ads_agreed,
        created_at
        FROM student
        <where>
            <if test="!isAdmin">
                ACADEMY_ID = #{academyId}
            </if>
        </where>
        ) AS subquery
        WHERE rnum BETWEEN #{start} AND #{end}
    </select>


    <select id="getStudentGrades" resultType="GetStudentGradesDTO">
        SELECT row_number() over (order by discount_rate desc) rnum, g.*
        FROM (SELECT a.academy_id
                , g.grade_id
                , a.academy_name
                , g.created_at
                , g.grade_name
                , g.discount_rate
                , (SELECT COUNT(student_id) FROM student s WHERE s.grade_id = g.GRADE_ID) student_count
            FROM grade g
            INNER JOIN academy a
            ON a.academy_id = g.academy_id
            WHERE g.academy_id = #{academyId}
            ORDER BY discount_rate DESC
            ) g;
    </select>
</mapper>