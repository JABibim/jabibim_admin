<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<head>
    <meta charset="UTF-8">
    <title>중앙비빔 Admin</title>
    <style>
        dialog {
            width: 300px;
            z-index: 100;
            padding: 30px;
            margin: 0;
            background: white;
            left: 50%;
            top: 40%;
            transform: translate(-50%, -50%);
            box-shadow: 2px 2px 5px rgba(0, 0, 0, .5);
            border: none;
            border-radius: 10px;
        }

        /* 요일 헤더 색상 */
        .fc-day-sun .fc-col-header-cell-cushion {
            color: red;
        }

        .fc-day-sat .fc-col-header-cell-cushion {
            color: blue;
        }

        /* 날짜 숫자 색상 */
        .fc-daygrid-day.fc-day-sun .fc-daygrid-day-number {
            color: red;
        }

        .fc-daygrid-day.fc-day-sat .fc-daygrid-day-number {
            color: blue;
        }

        .fc-daygrid-day.fc-day-weekday .fc-daygrid-day-number {
            color: black;
        }

        #authorize_button, #signout_button {
            margin: 10px;
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #signout_button {
            background-color: #d9534f;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.15/index.global.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script> <!-- Google API 라이브러리 추가 -->
    <script>
        const CLIENT_ID = '<YOUR_CLIENT_ID>'; // Google Cloud Console에서 생성한 OAuth2 Client ID
        const API_KEY = '<YOUR_API_KEY>'; // Google API Key
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/calendar.events.readonly";

        let gapiInited = false;
        let gisInited = false;

        document.getElementById('authorize_button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = handleSignoutClick;

        // Google API 클라이언트 초기화
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES,
            });
            gapiInited = true;
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        }

        // Google Identity Services 초기화
        function gisLoaded() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // onTokenResponse 콜백을 나중에 설정
            });

            document.getElementById('authorize_button').onclick = () => {
                tokenClient.callback = async (response) => {
                    if (response.error) {
                        throw response;
                    }
                    updateSigninStatus(true);
                };

                tokenClient.requestAccessToken({ prompt: 'consent' });
            };

            document.getElementById('signout_button').onclick = () => {
                google.accounts.oauth2.revoke(tokenClient.token.access_token);
                updateSigninStatus(false);
            };

            gisInited = true;
        }

        // 로그인 상태 업데이트
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'block';
                listUpcomingEvents();
            } else {
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
            }
        }

        // 구글 캘린더 데이터 가져오기
        async function listUpcomingEvents() {
            const response = await gapi.client.calendar.events.list({
                calendarId: 'primary',
                timeMin: new Date().toISOString(),
                showDeleted: false,
                singleEvents: true,
                maxResults: 10,
                orderBy: 'startTime',
            });

            const events = response.result.items;
            if (!events || events.length === 0) {
                console.log("No upcoming events found.");
                return;
            }

            const calendarEvents = events.map(event => ({
                title: event.summary,
                start: event.start.dateTime || event.start.date,
                end: event.end.dateTime || event.end.date,
            }));

            renderCalendar(calendarEvents);
        }

        // FullCalendar 렌더링
        function renderCalendar(events) {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: events,
                dateClick: function (info) {
                    alert("날짜 클릭: " + info.dateStr);
                },
            });
            calendar.render();
        }

        // Google API 및 Identity Services 로드
        function handleClientLoad() {
            gapi.load('client:auth2', gapiLoaded);
            gisLoaded();
        }
    </script>
    <script src="https://apis.google.com/js/platform.js?onload=handleClientLoad" async defer></script>

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>개인일정 관리</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{dashboard}">개인일정</a></li>
                    <li class="breadcrumb-item active">개인일정 목록</li>
                </ol>
            </nav>
        </div><!-- End Page Title -->
        <div class="card">
            <div class="card-body">
                <!-- Google 로그인 버튼 -->
                <button id="authorize_button">Google 로그인</button>
                <button id="signout_button" style="display: none;">로그아웃</button>
                <div id="calendar"></div>
                <dialog>
                    <div>제목 테스트</div>
                    <button>닫기</button>
                </dialog>
            </div>
        </div>
    </main><!-- End #main -->
</div>

<!-- 위로가기 버튼입니다 -->
<a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>

</body>
</html>
