<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<head>
    <meta charset="UTF-8">
    <title>중앙비빔 Admin</title>
    <style>
        dialog{
            width: 300px;
            z-index: 100;
            padding : 30px;
            margin: 0;
            background: white;
            left:50%;
            top:40%;
            transform: translate(-50%,-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,.5);
            border:none;
            border-radius:10px;
        }
        /* 요일 헤더 색상 */
        .fc-day-sun .fc-col-header-cell-cushion {
            color: red;
        }

        .fc-day-sat .fc-col-header-cell-cushion {
            color: blue;
        }

        /* 날짜 숫자 색상 */
        .fc-daygrid-day.fc-day-sun .fc-daygrid-day-number {
            color: red;
        }

        .fc-daygrid-day.fc-day-sat .fc-daygrid-day-number {
            color: blue;
        }

        .fc-daygrid-day.fc-day-weekday .fc-daygrid-day-number {
            color: black;
        }
    </style>

</head>
<body>
<div layout:fragment="content">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.15/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            let popup = document.querySelector('dialog');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                googleCalendarApiKey: 'AIzaSyBXFz8vCh6SbLBDmddYajLubFWJMGs2DRM',
                events:
                    {
                        googleCalendarId: 'f42bfe4a0e07e48e56920950dbe4b49dd6a91d6c265b0af89a28cf6ab17f22bd@group.calendar.google.com',
                    },
                eventSources:
                    {
                        googleCalendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
                        backgroundColor: 'red',
                        textColor: 'white' // 추가로 글자 색상 지정 가능
                    },
                dayCellDidMount: function (info) {
                    const date = new Date(info.date); // 날짜 가져오기
                    const day = date.getDay(); // 요일 가져오기 (0: 일요일, 6: 토요일)

                    // 날짜 번호 요소 가져오기
                    const dayNumberElement = info.el.querySelector('.fc-daygrid-day-number');

                    // 요일에 따라 색상 적용
                    if (day === 0) {
                        dayNumberElement.style.color = 'red'; // 일요일은 빨간색
                    } else if (day === 6) {
                        dayNumberElement.style.color = 'blue'; // 토요일은 파란색
                    } else {
                        dayNumberElement.style.color = 'black'; // 평일은 검정색
                    }
                },
                eventClick: function (info) {
                    info.jsEvent.preventDefault(); // 브라우저 기본 동작 방지
                    const eventDescription = info.event.extendedProps.description || '설명 없음';
                    const eventStart = info.event.start.toLocaleString(); // 시작 시간
                    const eventEnd = info.event.end ? info.event.end.toLocaleString() : '없음'; // 종료 시간
                    const eventLocation = info.event.extendedProps.location || '위치 정보 없음'; // 위치
                    console.log(info.event.extendedProps);
                    popup.querySelector('div').innerHTML = `
                    <h3>${info.event.title}</h3>
                    <div><strong>설명:</strong> ${eventDescription}</div>
                    <div><strong>시작 시간:</strong> ${eventStart}</div>
                    <div><strong>종료 시간:</strong> ${eventEnd}</div>
                    <div><strong>위치:</strong> ${eventLocation}</div>
                `;
                    popup.setAttribute('open', 'open');
                },
            });

            calendar.render();

            // 팝업 닫기 버튼 이벤트
            popup.querySelector('button').addEventListener('click', () => {
                popup.removeAttribute('open');
            });

            // 구글 캘린더 연동하기 버튼 클릭 이벤트
            document.getElementById('googleCalendarBtn').addEventListener('click', function () {
                const clientId = '528933010317-q1atrvppp0hcg68qi2mmm94m82n7dhgc.apps.googleusercontent.com';
                const redirectUri = 'https://localhost:5000/auth/google/callback';
                const scope = 'https://www.googleapis.com/auth/calendar';
                const responseType = 'code';

                // Google OAuth 인증 URL 생성
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=${responseType}
                                                                                       &client_id=${clientId}
                                                                                       &redirect_uri=${encodeURIComponent(redirectUri)}
                                                                                       &scope=${encodeURIComponent(scope)}`;

                // 팝업 창 열기
                const width = 600;
                const height = 700;
                const left = (window.screen.width - width) / 2;
                const top = (window.screen.height - height) / 2;

                const popupWindow = window.open(authUrl, 'GoogleOAuthPopup', `width=${width},height=${height},left=${left},top=${top}`);

                // 부모 창과 팝업 창 통신 처리
                const interval = setInterval(() => {
                    try {
                        // 팝업 창이 닫혔는지 확인
                        if (popupWindow.closed) {
                            clearInterval(interval);
                            alert('팝업이 닫혔습니다. 인증이 완료되지 않았습니다.');
                        }

                        // 인증 코드가 전달되었는지 확인
                        const url = new URL(popupWindow.location);
                        if (url.searchParams.get('code')) {
                            const code = url.searchParams.get('code');
                            console.log('인증 코드:', code);

                            // 부모 창에서 인증 코드로 추가 작업
                            popupWindow.close(); // 팝업 닫기
                            clearInterval(interval);
                            alert('인증이 완료되었습니다!');
                        }
                    } catch (e) {
                    }
                }, 1000);
            });

        });
    </script>

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>개인일정 관리</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{dashboard}">개인일정</a></li>
                    <li class="breadcrumb-item active">개인일정 목록</li>
                </ol>
            </nav>
        </div><!-- End Page Title -->
        <div class="card">
            <div class="card-body">
                <br>
                <button class="btn btn-outline-primary btn-sm" style="float: right" id="googleCalendarBtn"><img style="width:25px" th:src="@{/img/calendar.png}">구글 캘린더 연동하기</button>
                <br><br>
                <div id='calendar'></div>
                <dialog>
                    <div>제목 테스트</div>
                    <button>닫기</button>
                </dialog>
            </div>
        </div>
    </main><!-- End #main -->
</div>

<!-- 위로가기 버튼입니다 -->
<a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>

</body>
</html>